version: "1"
checks:
  - id: "aws-sg-ingress-sensitive-ports.nqe"
    title: "AWS SG: Internet ingress to sensitive ports"
    category: "cloud-policy-risk"
    severity: "high"
    description: "Flags AWS Security Group ingress PERMIT rules allowing 0.0.0.0/0 (or unspecified) to reach sensitive TCP/UDP ports."
    params:
      - name: "sensitivePorts"
        type: "List<Integer>"
        default: [22, 23, 3389, 445, 1433, 1521, 3306, 5432, 6379, 9200, 27017]
        description: "Ports considered sensitive when exposed to the internet."

  - id: "aws-sg-ingress-any-service.nqe"
    title: "AWS SG: Internet ingress any-service"
    category: "cloud-policy-risk"
    severity: "high"
    description: "Flags AWS Security Group ingress PERMIT rules allowing 0.0.0.0/0 (or unspecified) on any protocol/port."

  - id: "aws-sg-egress-any-service.nqe"
    title: "AWS SG: Internet egress any-service"
    category: "cloud-policy-risk"
    severity: "medium"
    description: "Flags AWS Security Group egress PERMIT rules allowing 0.0.0.0/0 (or unspecified) on any protocol/port (exfil posture signal)."

  - id: "acl-any-any-permit.nqe"
    title: "PERMIT any-to-any (modeled ACL)"
    category: "policy-risk"
    severity: "high"
    description: "Flags modeled ACL entries that permit 0.0.0.0/0 to 0.0.0.0/0."

  - id: "acl-any-to-rfc1918-sensitive-ports.nqe"
    title: "PERMIT any-to-RFC1918 on sensitive ports (modeled ACL)"
    category: "policy-risk"
    severity: "high"
    description: "Flags modeled ACL entries that permit any source to RFC1918 destinations on sensitive TCP/UDP ports."
    params:
      - name: "sensitivePorts"
        type: "List<Integer>"
        default: [22, 23, 445, 3389, 1433, 1521, 3306, 5432, 6379, 9200, 27017]
        description: "Ports considered sensitive when permitted to private address space."

  - id: "acl-any-to-zone-any-service.nqe"
    title: "PERMIT any-to-zone any-service (modeled ACL)"
    category: "segmentation"
    severity: "high"
    description: "Flags PERMIT rules from any source to dstSubnets with any protocol/port."
    params:
      - name: "dstSubnets"
        type: "List<String>"
        description: "Destination zone subnets (CIDR strings)."
        required: true
      - name: "firewallsOnly"
        type: "Bool"
        default: true
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false

  - id: "acl-any-to-zone-sensitive-ports.nqe"
    title: "PERMIT any-to-zone sensitive ports (modeled ACL)"
    category: "segmentation"
    severity: "high"
    description: "Flags PERMIT rules from any source to dstSubnets on sensitive ports."
    params:
      - name: "dstSubnets"
        type: "List<String>"
        description: "Destination zone subnets (CIDR strings)."
        required: true
      - name: "sensitivePorts"
        type: "List<Integer>"
        default: [22, 23, 3389, 445, 1433, 1521, 3306, 5432, 6379, 9200, 27017]
        description: "Ports considered sensitive when permitted into the zone."
      - name: "firewallsOnly"
        type: "Bool"
        default: true
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false

  - id: "acl-stale-permits-30d.nqe"
    title: "Stale PERMIT rules (unused for N days)"
    category: "policy-hygiene"
    severity: "medium"
    description: "Flags PERMIT rules with lastUsed older than N days relative to device snapshot collection time, or missing usage telemetry."
    params:
      - name: "daysWindow"
        type: "Integer"
        default: 30
        description: "Staleness threshold (days)."

  - id: "acl-new-permits-30d.nqe"
    title: "New PERMIT rules (created in last N days)"
    category: "policy-lifecycle"
    severity: "low"
    description: "Flags configured PERMIT rules created within N days of snapshot collection time (firewalls)."
    params:
      - name: "daysWindow"
        type: "Integer"
        default: 30
        description: "Lookback window (days)."

  - id: "acl-modified-permits-30d.nqe"
    title: "Modified PERMIT rules (changed in last N days)"
    category: "policy-lifecycle"
    severity: "low"
    description: "Flags configured PERMIT rules modified within N days of snapshot collection time (firewalls)."
    params:
      - name: "daysWindow"
        type: "Integer"
        default: 30
        description: "Lookback window (days)."

  - id: "acl-unused-permits-days.nqe"
    title: "Unused PERMIT rules (older than N days)"
    category: "policy-recert"
    severity: "medium"
    description: "Flags firewall PERMIT rules unused for N days (optionally includes missing usage telemetry)."
    params:
      - name: "daysWindow"
        type: "Integer"
        default: 30
        description: "Lookback window (days)."
      - name: "includeUnknownUsage"
        type: "Bool"
        default: true
        description: "Include rules that have no lastUsed/hitCount telemetry."

  - id: "acl-never-hit-permits.nqe"
    title: "Never-hit PERMIT rules (hitCount == 0)"
    category: "policy-recert"
    severity: "medium"
    description: "Flags firewall PERMIT rules with truncatedHitCount present and equal to zero."

  - id: "acl-permit-any-service.nqe"
    title: "PERMIT rules with any service match (any protocol and any port)"
    category: "policy-risk"
    severity: "high"
    description: "Flags firewall PERMIT rules whose modeled service is effectively 'any'."

  - id: "acl-flow-to-rules.nqe"
    title: "Flow to rules (modeled ACL)"
    category: "policy-analytics"
    severity: "low"
    description: "Given a flow tuple, list modeled ACL entries that match it (ordered)."
    params:
      - name: "srcIp"
        type: "String"
        description: "Source IP address (IPv4)."
        required: true
      - name: "dstIp"
        type: "String"
        description: "Destination IP address (IPv4)."
        required: true
      - name: "ipProto"
        type: "Integer"
        default: -1
        description: "IP protocol number (6 TCP, 17 UDP). Use -1 to ignore."
      - name: "dstPort"
        type: "Integer"
        default: -1
        description: "Destination port. Use -1 to ignore."
      - name: "firewallsOnly"
        type: "Bool"
        default: true
        description: "Limit to devices typed as FIREWALL."
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false
        description: "Include implicit/default rules."

  - id: "acl-flow-decision.nqe"
    title: "Flow decision (first match) (modeled ACL)"
    category: "policy-analytics"
    severity: "low"
    description: "Given a flow tuple, compute the first matching modeled ACL entry per device (effective decision)."
    params:
      - name: "srcIp"
        type: "String"
        description: "Source IP address (IPv4)."
        required: true
      - name: "dstIp"
        type: "String"
        description: "Destination IP address (IPv4)."
        required: true
      - name: "ipProto"
        type: "Integer"
        default: -1
        description: "IP protocol number (6 TCP, 17 UDP). Use -1 to ignore."
      - name: "dstPort"
        type: "Integer"
        default: -1
        description: "Destination port. Use -1 to ignore."
      - name: "firewallsOnly"
        type: "Bool"
        default: true
        description: "Limit to devices typed as FIREWALL."
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false
        description: "Include implicit/default rules."

  - id: "acl-shadowed-rules.nqe"
    title: "Shadowed rules (modeled ACL)"
    category: "policy-analytics"
    severity: "medium"
    description: "Flags rules fully shadowed by earlier rules with same action."
    params:
      - name: "firewallsOnly"
        type: "Bool"
        default: true
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false

  - id: "acl-partial-shadowed-rules.nqe"
    title: "Partially shadowed rules (modeled ACL)"
    category: "policy-analytics"
    severity: "medium"
    description: "Flags rules that overlap earlier rules with the same action but are not fully shadowed."
    params:
      - name: "firewallsOnly"
        type: "Bool"
        default: true
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false

  - id: "acl-unreachable-rules.nqe"
    title: "Unreachable rules (modeled ACL)"
    category: "policy-analytics"
    severity: "high"
    description: "Flags rules that can never be effective because an earlier rule fully covers their match region (first-match)."
    params:
      - name: "firewallsOnly"
        type: "Bool"
        default: true
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false

  - id: "acl-redundant-rules.nqe"
    title: "Redundant rules (modeled ACL)"
    category: "policy-analytics"
    severity: "medium"
    description: "Flags rules with equivalent match/action (duplicate policy)."
    params:
      - name: "firewallsOnly"
        type: "Bool"
        default: true
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false

  - id: "acl-overlap-conflicts.nqe"
    title: "Overlapping conflicts (modeled ACL)"
    category: "policy-analytics"
    severity: "high"
    description: "Flags overlapping rules with different actions (first-match pitfalls)."
    params:
      - name: "firewallsOnly"
        type: "Bool"
        default: true
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false

  - id: "acl-zone-to-zone-any-service.nqe"
    title: "Zone-to-zone any-service PERMIT (modeled ACL)"
    category: "segmentation"
    severity: "high"
    description: "Flags PERMIT rules that overlap a zone boundary (srcSubnets->dstSubnets) with any protocol/port."
    params:
      - name: "srcSubnets"
        type: "List<String>"
        description: "Source zone subnets (CIDR strings)."
        required: true
      - name: "dstSubnets"
        type: "List<String>"
        description: "Destination zone subnets (CIDR strings)."
        required: true
      - name: "firewallsOnly"
        type: "Bool"
        default: true
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false

  - id: "acl-zone-to-zone-sensitive-ports.nqe"
    title: "Zone-to-zone sensitive ports PERMIT (modeled ACL)"
    category: "segmentation"
    severity: "high"
    description: "Flags PERMIT rules that overlap a zone boundary (srcSubnets->dstSubnets) and include sensitive TCP/UDP ports."
    params:
      - name: "srcSubnets"
        type: "List<String>"
        description: "Source zone subnets (CIDR strings)."
        required: true
      - name: "dstSubnets"
        type: "List<String>"
        description: "Destination zone subnets (CIDR strings)."
        required: true
      - name: "sensitivePorts"
        type: "List<Integer>"
        default: [22, 23, 3389, 445, 1433, 1521, 3306, 5432, 6379, 9200, 27017]
        description: "Ports considered sensitive across the zone boundary."
      - name: "firewallsOnly"
        type: "Bool"
        default: true
      - name: "includeImplicitDefault"
        type: "Bool"
        default: false

  - id: "default-route-urpf-heuristic.nqe"
    title: "Default route without obvious uRPF (config heuristic)"
    category: "routing-hardening"
    severity: "medium"
    description: "Heuristic: device has a default route but no obvious uRPF line in config."

  - id: "ospf-passive-default.nqe"
    title: "OSPF passive-interface default missing (config heuristic)"
    category: "routing-hardening"
    severity: "low"
    description: "Flags OSPF processes missing 'passive-interface default' in router ospf stanzas."

  - id: "nat-flow-matches.nqe"
    title: "NAT flow matches (modeled NAT)"
    category: "policy-analytics"
    severity: "low"
    description: "Given a flow tuple, list modeled NAT entries that match it (ordered)."
    params:
      - name: "srcIp"
        type: "String"
        description: "Source IP address (IPv4)."
        required: true
      - name: "dstIp"
        type: "String"
        description: "Destination IP address (IPv4)."
        required: true
      - name: "ipProto"
        type: "Integer"
        default: -1
        description: "IP protocol number (6 TCP, 17 UDP). Use -1 to ignore."
      - name: "dstPort"
        type: "Integer"
        default: -1
        description: "Destination port. Use -1 to ignore."

  - id: "assurance-enforcement-points.nqe"
    title: "Assurance helper: enforcement points"
    category: "assurance"
    severity: "low"
    description: "Helper query: returns devices that should be treated as enforcement points (by device type and optional exact tag/name matches)."
    params:
      - name: "enforcementDeviceTypes"
        type: "List<String>"
        default: []
        description: "Optional: explicit deviceType strings (case-insensitive). Empty uses conservative defaults."
      - name: "enforcementDeviceNameParts"
        type: "List<String>"
        default: []
        description: "Optional: exact (case-insensitive) device name matches. Go layer may still apply substring matching against hop metadata."
      - name: "enforcementTagParts"
        type: "List<String>"
        default: []
        description: "Optional: exact (case-insensitive) tag/group matches. Go layer may still apply substring matching against hop metadata."
      - name: "includeGroups"
        type: "Bool"
        default: true
        description: "If true, tag matching also considers groupNames."

  - id: "assurance-posture-summary.nqe"
    title: "Assurance posture summary (single query)"
    category: "assurance"
    severity: "low"
    description: "Single-query posture summary for the assurance dashboard (bundles several high-signal findings)."
    params:
      - name: "sensitivePorts"
        type: "List<Integer>"
        default: [22, 23, 445, 3389, 1433, 1521, 3306, 5432, 6379, 9200, 27017]
        description: "Ports considered sensitive when permitted to private address space."
